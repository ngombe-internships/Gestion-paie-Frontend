<div class="mes-conges-container">
  <!-- En-tête -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          <i class="bi bi-calendar-check text-primary"></i>
          Mes Demandes de Congés
        </h1>
        <p class="page-subtitle">Suivez vos demandes et gérez vos congés</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline-primary btn-sm" (click)="refresh()" [disabled]="isLoading">
          <i class="bi bi-arrow-clockwise"></i>
          <span class="d-none d-md-inline">Actualiser</span>
        </button>
        <button class="btn btn-primary btn-sm" (click)="naviguerVersNouvelleDemandeAbsolue()">
          <i class="bi bi-plus-lg"></i>
          <span class="d-none d-md-inline">Nouvelle demande</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Statistiques rapides -->
  <div class="stats-grid" *ngIf="!isLoading && !error">
    <div class="stat-card total">
      <div class="stat-value">{{ stats.total }}</div>
      <div class="stat-label">Total demandes</div>
    </div>
    <div class="stat-card pending">
      <div class="stat-value">{{ stats.enAttente }}</div>
      <div class="stat-label">En attente</div>
    </div>
    <div class="stat-card approved">
      <div class="stat-value">{{ stats.approuvees }}</div>
      <div class="stat-label">Approuvées</div>
    </div>
    <div class="stat-card rejected">
      <div class="stat-value">{{ stats.refusees }}</div>
      <div class="stat-label">Refusées</div>
    </div>
    <div class="stat-card cancelled" *ngIf="stats.annulees > 0">
      <div class="stat-value">{{ stats.annulees }}</div>
      <div class="stat-label">Annulées</div>
    </div>
  </div>

  <!-- ✅ FILTRES AMÉLIORÉS -->
  <div class="filters-section" *ngIf="!isLoading && !error">
    <!-- Filtre Statut -->
    <div class="filter-group">
      <label>Statut :</label>
      <div class="filter-buttons">
        <button
          class="filter-btn"
          [class.active]="filtreStatut === 'TOUS'"
          (click)="changerFiltreStatut('TOUS')">
          Tous
        </button>
        <button
          class="filter-btn pending"
          [class.active]="filtreStatut === 'EN_ATTENTE'"
          (click)="changerFiltreStatut('EN_ATTENTE')">
          En attente ({{ stats.enAttente }})
        </button>
        <button
          class="filter-btn approved"
          [class.active]="filtreStatut === 'APPROUVEE'"
          (click)="changerFiltreStatut('APPROUVEE')">
          Approuvées ({{ stats.approuvees }})
        </button>
        <button
          class="filter-btn rejected"
          [class.active]="filtreStatut === 'REJETEE'"
          (click)="changerFiltreStatut('REJETEE')">
          Refusées ({{ stats.refusees }})
        </button>
        <button
          class="filter-btn cancelled"
          [class.active]="filtreStatut === 'ANNULEE'"
          (click)="changerFiltreStatut('ANNULEE')"
          *ngIf="stats.annulees > 0">
          Annulées ({{ stats.annulees }})
        </button>
      </div>
    </div>

    <!-- ✅ NOUVEAU :  Filtre Année amélioré -->
    <div class="filter-group filter-annee">
      <label>Année :</label>
      <div class="annee-selector">
        <select class="form-select form-select-sm" [(ngModel)]="filtreAnnee" (ngModelChange)="changerFiltreAnnee($event)">
          <option *ngFor="let annee of getAnneesDisponibles()" [ngValue]="annee. value">
            {{ annee.label }}
          </option>
        </select>
        
        <!-- Bouton revenir à l'année actuelle -->
        <button 
          *ngIf="! estAnneeActuelle() && ! afficheToutesAnnees()"
          class="btn btn-outline-primary btn-sm btn-annee-actuelle"
          (click)="revenirAnneeActuelle()"
          title="Revenir à l'année actuelle">
          <i class="bi bi-calendar-event"></i>
          {{ anneeActuelle }}
        </button>
        
        <!-- Bouton voir tout -->
        <button 
          *ngIf="!afficheToutesAnnees()"
          class="btn btn-outline-secondary btn-sm btn-toutes-annees"
          (click)="afficherToutesLesAnnees()"
          title="Voir toutes les années">
          <i class="bi bi-calendar-range"></i>
          Tout
        </button>
      </div>
    </div>

    <!-- Champ de recherche -->
    <div class="filter-group filter-search">
      <label>Recherche :</label>
      <div class="input-group input-group-sm">
        <input
          type="text"
          class="form-control"
          placeholder="Rechercher..."
          [(ngModel)]="searchText"
          (input)="onSearch()">
        <button
          class="btn btn-outline-secondary"
          type="button"
          (click)="clearSearch()"
          *ngIf="searchText">
          <i class="bi bi-x"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- ✅ NOUVEAU : Badge du filtre actif -->
  <div class="active-filters mb-3" *ngIf="! isLoading && ! error && (filtreAnnee !== anneeActuelle || filtreStatut !== 'TOUS' || searchText)">
    <span class="filter-badge" *ngIf="filtreAnnee === 0">
      <i class="bi bi-calendar-range me-1"></i>
      Toutes les années
      <button class="btn-remove-filter" (click)="revenirAnneeActuelle()">
        <i class="bi bi-x"></i>
      </button>
    </span>
    <span class="filter-badge" *ngIf="filtreAnnee > 0 && filtreAnnee !== anneeActuelle">
      <i class="bi bi-calendar me-1"></i>
      Année {{ filtreAnnee }}
      <button class="btn-remove-filter" (click)="revenirAnneeActuelle()">
        <i class="bi bi-x"></i>
      </button>
    </span>
    <span class="filter-badge" *ngIf="filtreStatut !== 'TOUS'">
      <i class="bi bi-funnel me-1"></i>
        {{ filtreStatut === 'TOUS' ? 'Tous les statuts' :  getStatutLabel($any(filtreStatut)) }}      <button class="btn-remove-filter" (click)="changerFiltreStatut('TOUS')">
        <i class="bi bi-x"></i>
      </button>
    </span>
    <span class="filter-badge" *ngIf="searchText">
      <i class="bi bi-search me-1"></i>
      "{{ searchText }}"
      <button class="btn-remove-filter" (click)="clearSearch()">
        <i class="bi bi-x"></i>
      </button>
    </span>
    <button class="btn btn-link btn-sm text-danger" (click)="reinitialiserFiltres()">
      <i class="bi bi-x-circle me-1"></i>
      Réinitialiser tout
    </button>
  </div>

  <!-- États de chargement -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Chargement de vos demandes... </p>
  </div>

  <div *ngIf="error && !isLoading" class="error-state">
    <i class="bi bi-exclamation-triangle"></i>
    <h3>Erreur de chargement</h3>
    <p>{{ error }}</p>
    <button class="btn btn-primary" (click)="refresh()">
      <i class="bi bi-arrow-clockwise"></i>
      Réessayer
    </button>
  </div>

  <!-- SECTION :  Tableau des demandes -->
  <div *ngIf="! isLoading && ! error" class="demandes-container">
    
    <!-- ✅ NOUVEAU : Message "Aucune demande" amélioré -->
    <div *ngIf="demandes.length === 0" class="empty-state">
      <div class="empty-icon">
        <i class="bi bi-calendar-x"></i>
      </div>
      
      <!-- Message différent selon le filtre -->
      <ng-container *ngIf="filtreAnnee === 0">
        <h3>Aucune demande de congé</h3>
        <p>Vous n'avez encore fait aucune demande de congé.</p>
      </ng-container>
      
      <ng-container *ngIf="filtreAnnee > 0">
        <h3>Aucune demande pour {{ filtreAnnee }}</h3>
        <p>Vous n'avez pas de demande de congé soumise en {{ filtreAnnee }}.</p>
        
        <!-- ✅ Boutons d'action -->
        <div class="empty-actions">
          <button class="btn btn-outline-primary me-2" (click)="revenirAnneeActuelle()" *ngIf="filtreAnnee !== anneeActuelle">
            <i class="bi bi-calendar-event me-1"></i>
            Voir {{ anneeActuelle }}
          </button>
          <button class="btn btn-outline-secondary me-2" (click)="afficherToutesLesAnnees()">
            <i class="bi bi-calendar-range me-1"></i>
            Voir toutes les années
          </button>
        </div>
      </ng-container>
      
      <button class="btn btn-primary mt-3" (click)="naviguerVersNouvelleDemandeAbsolue()">
        <i class="bi bi-plus-lg me-1"></i>
        Faire une demande
      </button>
    </div>

    <!-- Aucun résultat avec filtres -->
    <div *ngIf="demandes.length > 0 && demandesFiltrees.length === 0" class="empty-state">
      <div class="empty-icon warning">
        <i class="bi bi-funnel"></i>
      </div>
      <h3>Aucun résultat</h3>
      <p>Aucune demande ne correspond à vos critères de filtrage.</p>
      
      <div class="empty-actions">
        <button class="btn btn-outline-primary me-2" (click)="reinitialiserFiltres()">
          <i class="bi bi-arrow-counterclockwise me-1"></i>
          Réinitialiser les filtres
        </button>
        <button class="btn btn-outline-secondary" (click)="afficherToutesLesAnnees()">
          <i class="bi bi-calendar-range me-1"></i>
          Voir toutes les années
        </button>
      </div>
    </div>

    <!-- Tableau des demandes -->
    <div *ngIf="demandesFiltrees.length > 0" class="table-section">
      <div class="table-header">
        <h5>
          <i class="bi bi-list-ul me-2"></i>
          {{ demandesFiltrees.length }} demande(s) trouvée(s)
        </h5>
        <small class="text-muted">
          {{ getFiltreLabel() }}
          <span *ngIf="filtreAnnee > 0"> • Année {{ filtreAnnee }}</span>
          <span *ngIf="filtreAnnee === 0"> • Toutes les années</span>
        </small>
      </div>

      <div class="table-responsive">
        <table class="table table-hover table-striped">
          <thead class="table-dark">
            <tr>
              <th>Période</th>
              <th>Type</th>
              <th>Durée</th>
              <th>Statut</th>
              <th>Demandé le</th>
              <th>Raison</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let demande of demandesFiltrees; trackBy: trackByDemandeId">
              <!-- Période -->
              <td>
                <div class="periode-info">
                  <strong>{{ congeService.formatDateShort(demande. dateDebut) }}</strong>
                  <small class="text-muted d-block">au {{ congeService. formatDateShort(demande.dateFin) }}</small>
                </div>
              </td>

              <!-- Type de congé -->
              <td>
                <div class="type-info">
                  <span>{{ getTypeCongeLabel(demande.typeConge) }}</span>
                </div>
              </td>

              <!-- Durée -->
              <td class="text-center">
                <span class="badge bg-info">
                  {{ calculerJoursOuvrables(demande.dateDebut, demande. dateFin) }} j
                </span>
              </td>

              <!-- Statut -->
              <td>
                <span [ngClass]="getStatutClass(demande.statut)">
                  <i class="bi me-1" [ngClass]="congeService.getStatutIcon(demande.statut)"></i>
                  {{ getStatutLabel(demande.statut) }}
                </span>
              </td>

              <!-- Date de demande -->
              <td>
                <span class="text-muted">{{ congeService.formatDateShort(demande.dateDemande) }}</span>
              </td>

              <!-- Raison -->
              <td>
                <div class="raison-cell-full">
                  <div *ngIf="demande.raison" class="raison-text">
                    {{ demande.raison }}
                  </div>
                  <div *ngIf="demande.motifRejet" class="motif-rejet-text">
                    <i class="bi bi-exclamation-triangle me-1 text-danger"></i>
                    <strong class="text-danger">Motif de rejet :</strong>
                    <span class="text-danger">{{ demande. motifRejet }}</span>
                  </div>
                  <span *ngIf="!demande.raison && !demande.motifRejet" class="text-muted">-</span>
                </div>
              </td>

              <!-- Actions -->
              <td class="text-center">
                <button
                  *ngIf="peutAnnuler(demande)"
                  class="btn btn-outline-danger btn-sm"
                  (click)="ouvrirModalAnnulation(demande)"
                  title="Annuler cette demande">
                  <i class="bi bi-x-circle me-1"></i>
                  Annuler
                </button>
                <span *ngIf="!peutAnnuler(demande)" class="text-muted">-</span>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3 px-3 pb-3" *ngIf="totalPages > 1">
          <div class="text-muted">
            <small>
              Affichage {{ currentPage * itemsPerPage + 1 }} à
              {{ getMin((currentPage + 1) * itemsPerPage, totalItems) }}
              sur {{ totalItems }} demande(s)
            </small>
          </div>

          <nav aria-label="Navigation des pages">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="goToPage(0)">
                  <i class="bi bi-chevron-double-left"></i>
                </button>
              </li>
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="goToPage(currentPage - 1)">
                  <i class="bi bi-chevron-left"></i>
                </button>
              </li>
              <li class="page-item" *ngFor="let page of getPagesArray()" [class.active]="currentPage === page">
                <button class="page-link" (click)="goToPage(page)">{{ page + 1 }}</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="goToPage(currentPage + 1)">
                  <i class="bi bi-chevron-right"></i>
                </button>
              </li>
              <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
                <button class="page-link" (click)="goToPage(totalPages - 1)">
                  <i class="bi bi-chevron-double-right"></i>
                </button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal d'annulation -->
  <div class="modal fade" [class. show]="showModalAnnulation" [style.display]="showModalAnnulation ?  'block' :  'none'"
       *ngIf="showModalAnnulation" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Confirmer l'annulation
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="fermerModalAnnulation()"></button>
        </div>

        <div class="modal-body" *ngIf="demandeAnnuler">
          <div class="alert alert-warning">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Attention :</strong> Cette action est irréversible. 
          </div>

          <h6>Vous êtes sur le point d'annuler cette demande :</h6>

          <div class="demande-details bg-light p-3 rounded mt-3">
            <div class="row">
              <div class="col-md-6">
                <strong>Type :</strong><br>
                <span class="text-muted">{{ getTypeCongeLabel(demandeAnnuler.typeConge) }}</span>
              </div>
              <div class="col-md-6">
                <strong>Statut actuel :</strong><br>
                <span [ngClass]="getStatutClass(demandeAnnuler.statut)">
                  {{ getStatutLabel(demandeAnnuler.statut) }}
                </span>
              </div>
            </div>

            <div class="row mt-2">
              <div class="col-md-6">
                <strong>Du :</strong><br>
                <span class="text-muted">{{ congeService.formatDate(demandeAnnuler.dateDebut) }}</span>
              </div>
              <div class="col-md-6">
                <strong>Au :</strong><br>
                <span class="text-muted">{{ congeService.formatDate(demandeAnnuler.dateFin) }}</span>
              </div>
            </div>

            <div class="row mt-2">
              <div class="col-12">
                <strong>Durée :</strong><br>
                <span class="badge bg-info">
                  {{ calculerJoursOuvrables(demandeAnnuler.dateDebut, demandeAnnuler.dateFin) }} jour(s) ouvrable(s)
                </span>
              </div>
            </div>

            <div class="row mt-2" *ngIf="demandeAnnuler.raison">
              <div class="col-12">
                <strong>Raison :</strong><br>
                <span class="text-muted">{{ demandeAnnuler.raison }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="fermerModalAnnulation()">
            <i class="bi bi-x me-1"></i>
            Garder la demande
          </button>
          <button type="button" class="btn btn-danger" (click)="confirmerAnnulation()" [disabled]="annulationEnCours">
            <span *ngIf="annulationEnCours" class="spinner-border spinner-border-sm me-2"></span>
            <i *ngIf="!annulationEnCours" class="bi bi-trash me-1"></i>
            {{ annulationEnCours ? 'Annulation...' : 'Oui, annuler' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay pour le modal -->
  <div class="modal-backdrop fade" [class.show]="showModalAnnulation" *ngIf="showModalAnnulation"
       (click)="fermerModalAnnulation()"></div>
</div>